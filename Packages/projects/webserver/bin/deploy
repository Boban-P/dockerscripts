#!/bin/bash

set -e

function show_help() {
echo "Usage: $0 options
Create kubernets yaml file from configuration values and appy delete or print yaml file.
"
echo "Options:
--gcloud  [projectname] : deploy to gcloud, used for retrieving image.
--trusted  ip           : public ip address of balancer
--mail  ip              : mail server ip address
--dns   ip              : dns server ip address
--nfs   ip              : nfs server ip address
--file conffile         : yaml or template file will search for conffile.[template.].yaml
                           specify multiple times to concatenate multiple files.
                           default to namespace, configMap, volume and deployment
--print                 : do not deploy print generated configuration file.
--delete                : delete deployment
--help                  : show this help and exit
"
}

function sed_command() {
    for var in "${@:4}"; do
        if [[ ! -v ${var} ]]; then
            >&2 echo "undefined variable '$var' in file '$1'"
            exit 1
        fi
        value="$(eval "printf '%s' \$${var}")"
        ESCAPED_value=$(printf '%s\n' "$value" | sed -e 's/[\/&]/\\&/g')
        replace+=(-e "s/~$2{${var}}$3~/${ESCAPED_value}/g")
    done
}

function process_file () {
    NAME="$(sed 's/[^a-zA-Z0-9-]/-/g' <<<"${NAME}")"
    replace=()
    # GENERIC VARIABLES
    mapfile -t vars<<<"$(grep -o '~~{.*}~~' "$1" | sort -r | uniq |cut -d~ -f3 | cut -d{ -f2 | cut -d} -f1)"
    if [[ (${#vars[@]} -ne 1) || (-n "${vars[0]}") ]]; then
        sed_command "$1" '~' '~' "${vars[@]}"
    fi
    mapfile -t commands<<<"$(grep -o '~{.*}{.*}~' "$1" | cut -d~ -f2 | cut -d{ -f2 | cut -d} -f1 | sort | uniq)"
    if [[ (${#commands[@]} -ne 1) || (-n "${commands[0]}") ]]; then
        for command in "${commands[@]}"; do
            mapfile -t vars<<<"$(grep -o "~{${command}}{.*}~" "$1" | sort -r | uniq |cut -d~ -f2 | cut -d{ -f3 | cut -d} -f1)"
            if [[ (${#vars[@]} -ne 1) || (-n "${vars[0]}") ]]; then
                [[ ! -f "${DIR}/${command}.conf" ]] && >&2 echo "command:${command} configuration file not found while processing $1" && exit 1
                # include default values
                source "$(dirname "$(dirname "$(/usr/bin/which "${command}")")")/${command}.conf"
                source "${DIR}/${command}.conf"
                # for kubernets use registry prefix for image.
                eval "${command^^}_IMAGE=\"\${${command^^}_IMAGE:+\${IMAGE_PREFIX}\${${command^^}_IMAGE}}\""
                sed_command "$1" "{${command}}" "" "${vars[@]}"
            fi
        done
    fi
    if [[ ${#replace[@]} -ne 0 ]]; then
        sed "${replace[@]}" "$1"
    else
        cat "$1"
    fi
}

files=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --help)
            show_help
            exit
            ;;
        --gcloud)
            if [[ (-z "${2}") || ("$2" != "--"*) ]]; then
                PROJECT="$(gcloud config get-value project)"
            else
                PROJECT="$2"
                shift
            fi
            IMAGE_PREFIX="gcr.io/${PROJECT}/"
            ;;
        --trusted)
            [[ (-z "$2") || "$2" = "--"* ]] && >&2 echo "trusted ip address needed" && exit 1
            TRUSTED_PROXY="$2"
            shift
            ;;
        --mail)
            [[ (-z "$2") || "$2" = "--"* ]] && >&2 echo "--mail require server ip or host name" && exit 1
            MAIL_FORWARD_HOST="$2"
            shift
            ;;
        --dns)
            [[ (-z "$2") || "$2" = "--"* ]] && >&2 echo "--dns require server ip or host name" && exit 1
            DNS_SERVER="$2"
            shift
            ;;
        --nfs)
            [[ (-z "$2") || "$2" = "--"* ]] && >&2 echo "--nfs require network storage server ip or host name" && exit 1
            DATA_SERVER="$2"
            shift
            ;;
        --print)
            __PRINT__ONLY=1
            ;;
        --delete)
            __DELETE_DEPLOYMENT=1
            ;;
        --file)
            [[ (-z "$2") || "$2" = "--"* ]] && >&2 echo "--file require a template or yaml file to process" && exit 1
            files+=("$2")
            shift
            ;;
        *)
            >&2 echo "unknown option '$1' in commandline" && exit 1
            ;;
    esac
    shift
done

[[ -z "${MAIL_FORWARD_HOST}" ]] && >&2 echo "Mail server not configured use --mail" && exit 1
[[ -z "${DNS_SERVER}" ]] && >&2 echo "dns server not configured use --dns" && exit 1
[[ -z "${DATA_SERVER}" ]] && >&2 echo "network data server not configured use --nfs" && exit 1

if [[ ${#files[@]} -eq 0 ]]; then
    files=(namespace configMap volume deployment)
fi
source=()
base_DIR="$(dirname "$(dirname "${BASH_SOURCE[0]}")")"
for file in "${files[@]}"; do
    if [[ -f "${DIR}/${file}.yaml" ]]; then
        source+=("$(cat "${DIR}/${file}.yaml")")
    elif [[ -f "${DIR}/${file}.template.yaml" ]]; then
        source+=("$(process_file "${DIR}/${file}.template.yaml")")
    # elif [[ -f "${base_DIR}/${file}.yaml" ]]; then
    #     source+=("$(cat "${base_DIR}/${file}.yaml")")
    elif [[ -f "${base_DIR}/${file}.template.yaml" ]]; then
        source+=("$(process_file "${base_DIR}/${file}.template.yaml")")
    else
        >&2 echo "the file, $file.yaml or $file.template.yaml not found" && exit 1
    fi
done

if [[ -n "${__PRINT__ONLY}" ]]; then
    printf "%s\n---\n" "${source[@]}"
    exit 0
fi

[[ -z "${__DELETE_DEPLOYMENT}" ]] || kubectl delete -f <(printf "%s\n---\n" "${source[@]}")
kubectl apply -f <(printf "%s\n---\n" "${source[@]}")

#!/bin/bash

set -e


if [[ -n "$("APP_DATA_MOUNTS"}" ]]; then
    IFS=\; read -a -r files<<"${APP_DATA_MOUNTS}"
    for file in "${files[@]}; do
        source="${DATA_ROOT%/}/${file%%:*}"
        destination="${DOCUMENT_ROOT%/}/${file#*:}"
        if [[ (-f "${source}") && (-f "${destination}") ]]; then
            mount --bind "${source}" "${destination}"
        else
            >&2 echo "error: either of '${source}' or '${destination}' not found while looking for mount" && exit 1
        fi
    done
fi
if [[ -n "$("APP_CONFIG_MOUNTS"}" ]]; then
    IFS=\; read -a -r files<<"${APP_DATA_MOUNTS}"
    for file in "${files[@]}; do
        source="${CONFIG_ROOT%/}/${file%%:*}"
        destination="${DOCUMENT_ROOT%/}/${file#*:}"
        if [[ (-f "${source}") && (-f "${destination}") ]]; then
            mount --bind -o ro "${source}" "${destination}"
        else
            >&2 echo "error: either of '${source}' or '${destination}' not found while looking for mount" && exit 1
        fi
    done
fi
